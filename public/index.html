<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>Signal Chat UI</title>
<meta name="theme-color" content="#2C6BED">
<link rel="manifest" href="/manifest.json">

<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">

<style>
:root{--signal-blue:#2C6BED;--ios-curve:cubic-bezier(.4,0,.2,1)}
html,body{height:100%}
body{
  font-family:'Inter',sans-serif;
  background:#000;
  margin:0;
  overflow:hidden;
  display:flex;
  align-items:center;
  justify-content:center;
}
.scrollbar-hide::-webkit-scrollbar{display:none}
#main-app{display:flex;width:100%;height:100%;background:#fff;overflow:hidden}
#sidebar,#main-chat{height:100%;transition:.45s var(--ios-curve),opacity .35s}
@media(max-width:767px){
  #sidebar{width:100%;position:absolute;z-index:10}
  #main-chat{width:100%;position:absolute;transform:translateX(100%);z-index:20}
  .view-list #sidebar{transform:translateX(0)}
  .view-chat #sidebar{transform:translateX(-25%);opacity:.9}
  .view-chat #main-chat{transform:translateX(0)}
}
@media(min-width:768px){
  #main-app{height:95dvh;max-width:1280px;border-radius:1.25rem;border:1px solid #e5e7eb}
  #sidebar{width:360px;border-right:1px solid #f3f4f6}
  #main-chat{flex:1;transform:none!important}
}
.message-appear{animation:popIn .25s cubic-bezier(.175,.885,.32,1.15)}
@keyframes popIn{from{opacity:0;transform:scale(.94) translateY(8px)}to{opacity:1;transform:none}}

.bubble{max-width:78%;padding:12px 16px;border-radius:18px;font-size:16px}
.bubble.me{background:var(--signal-blue);color:#fff;border-bottom-right-radius:6px}
.bubble.other{background:#f3f4f6;color:#111827;border-bottom-left-radius:6px}
.meta-name{font-size:12px;color:#6b7280;margin-bottom:6px}

footer{padding:14px 18px;border-top:1px solid #eee;background:#fff;display:flex;gap:12px}
textarea{flex:1;resize:none;border:none;background:#f7fafc;border-radius:24px;padding:12px 16px;font-size:16px;outline:none}
.send-btn{width:48px;height:48px;border-radius:999px;background:var(--signal-blue);color:#fff;display:flex;align-items:center;justify-content:center}

/* typing indicator */
#typing-indicator{padding:0 24px 8px}
.typing-bubble{background:#f3f4f6;border-radius:18px;padding:8px 12px;display:inline-flex}
.dots{display:flex;gap:6px}
.dot{width:8px;height:8px;background:#9ca3af;border-radius:999px;animation:bounce 1s infinite}
.dot:nth-child(2){animation-delay:.12s}
.dot:nth-child(3){animation-delay:.24s}
@keyframes bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-6px)}}

/* onboarding */
#onboarding{position:fixed;inset:0;z-index:999;background:linear-gradient(135deg,#f0f4ff,#e0eaff);display:flex;align-items:center;justify-content:center}
.form-card{background:#fff;border-radius:24px;padding:28px;width:100%;max-width:420px}
</style>
</head>

<body class="view-list">

<!-- ONBOARDING -->
<div id="onboarding">
  <div class="form-card">
    <h1 class="text-2xl font-bold mb-2 text-center">Welcome</h1>
    <p class="text-gray-500 mb-4 text-center">Your display name</p>
    <form id="profileForm">
      <input id="nameInput" required placeholder="Enter your name"
        class="w-full px-4 py-3 rounded-xl border mb-4">
      <button class="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold">Continue</button>
    </form>
  </div>
</div>

<div id="main-app">
<!-- SIDEBAR -->
<aside id="sidebar" class="flex flex-col">
  <div class="p-6"><h1 class="font-bold text-2xl">Chats</h1></div>

  <!-- ✅ AVATAR RESTORED HERE -->
  <div class="px-3">
    <div onclick="switchChat()"
      class="p-4 rounded-2xl flex items-center gap-4 bg-blue-50 cursor-pointer">
      <img
        src="https://api.dicebear.com/7.x/avataaars/svg?seed=General"
        class="w-14 h-14 rounded-full bg-blue-100"
        alt="General avatar">
      <div>
        <div class="font-bold">General</div>
        <div class="text-sm text-gray-500">Public chat</div>
      </div>
    </div>
  </div>
</aside>

<!-- CHAT -->
<main id="main-chat" class="flex flex-col flex-1">
<header class="h-20 flex items-center px-6 border-b">
  <button onclick="goBack()" class="md:hidden mr-3 text-2xl">&larr;</button>
  <h2 class="font-bold text-lg">General</h2>
</header>

<div id="messages" class="flex-1 overflow-y-auto px-6 py-6 space-y-3 scrollbar-hide"></div>

<div id="typing-indicator" class="hidden">
  <div class="text-xs text-gray-500 mb-1" id="typing-name"></div>
  <div class="typing-bubble">
    <div class="dots">
      <div class="dot"></div><div class="dot"></div><div class="dot"></div>
    </div>
  </div>
</div>

<footer>
  <textarea id="input" rows="1" placeholder="Signal Message"></textarea>
  <button id="send" class="send-btn">➤</button>
</footer>
</main>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyCY2qB4sbPs_7BIz355cQiQkDDqK-S_z4I",
  projectId:"flux-chat-b9cb2"
});
const db=firebase.firestore();
const CHAT="general";

const MY_ID=localStorage.uid||(()=>{const i="u_"+Math.random().toString(36).slice(2,9);localStorage.uid=i;return i})();
const myName=()=>localStorage.name||"Anonymous";

const messagesEl=document.getElementById("messages");
const input=document.getElementById("input");
const send=document.getElementById("send");
const typingRef=db.collection("public").doc(CHAT).collection("typing");

/* onboarding */
if(localStorage.name) document.getElementById("onboarding").remove();
document.getElementById("profileForm").onsubmit=e=>{
  e.preventDefault();
  localStorage.name=document.getElementById("nameInput").value.trim();
  document.getElementById("onboarding").remove();
};

/* typing */
let tmo;
input.oninput=()=>{
  typingRef.doc(MY_ID).set({name:myName(),typing:true},{merge:true});
  clearTimeout(tmo);
  tmo=setTimeout(()=>typingRef.doc(MY_ID).set({typing:false},{merge:true}),1200);
};

/* listen typing */
typingRef.onSnapshot(s=>{
  let show=false,name="";
  s.forEach(d=>{if(d.id!==MY_ID && d.data().typing){show=true;name=d.data().name}});
  document.getElementById("typing-name").textContent=name;
  document.getElementById("typing-indicator").classList.toggle("hidden",!show);
});

/* send */
send.onclick=async()=>{
  const text=input.value.trim();
  if(!text) return;
  input.value="";
  await db.collection("public").doc(CHAT).collection("messages").add({
    text,senderId:MY_ID,name:myName(),clientTime:Date.now()
  });
  typingRef.doc(MY_ID).set({typing:false},{merge:true});
};

/* messages */
db.collection("public").doc(CHAT).collection("messages")
.orderBy("clientTime")
.onSnapshot(s=>{
  messagesEl.innerHTML="";
  s.forEach(d=>{
    const m=d.data();
    const wrap=document.createElement("div");
    wrap.className="flex flex-col "+(m.senderId===MY_ID?"items-end":"items-start")+" message-appear";
    if(m.senderId!==MY_ID){
      const n=document.createElement("div");
      n.className="meta-name";n.textContent=m.name;wrap.appendChild(n);
    }
    const b=document.createElement("div");
    b.className="bubble "+(m.senderId===MY_ID?"me":"other");
    b.textContent=m.text;
    wrap.appendChild(b);
    messagesEl.appendChild(wrap);
  });
  messagesEl.scrollTop=messagesEl.scrollHeight;
});

/* navigation */
function switchChat(){document.body.className="view-chat"}
function goBack(){document.body.className="view-list"}
</script>
</body>
</html>
