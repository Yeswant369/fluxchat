<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>Signal Chat UI</title>
<meta name="theme-color" content="#2C6BED">
<link rel="manifest" href="/manifest.json">

<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<style>
:root{
  --signal-blue:#2C6BED;
  --ios-curve:cubic-bezier(0.4,0,0.2,1);
}

/* üî¥ FIXED: NO FLEX CENTERING */
html,body{
  height:100%;
}
body{
  font-family:'Inter',sans-serif;
  background:#000;
  margin:0;
  overflow:hidden;
}

/* APP */
#main-app{
  width:100%;
  height:100%;
  background:#fff;
  display:flex;
  overflow:hidden;
}

/* SLIDE LOGIC ‚Äì UNTOUCHED */
#sidebar,#main-chat{
  height:100%;
  transition:transform .45s var(--ios-curve),opacity .35s ease;
}

@media(max-width:767px){
  #sidebar{width:100%;position:absolute;z-index:10}
  #main-chat{width:100%;position:absolute;transform:translateX(100%);z-index:20}
  .view-list #sidebar{transform:translateX(0)}
  .view-chat #sidebar{transform:translateX(-25%);opacity:.9}
  .view-chat #main-chat{transform:translateX(0)}
}

@media(min-width:768px){
  #main-app{
    height:95dvh;
    max-width:1280px;
    margin:auto;
    border-radius:1.25rem;
    border:1px solid #e5e7eb;
  }
  #sidebar{width:360px;border-right:1px solid #f3f4f6}
  #main-chat{flex:1;transform:none!important}
}

/* MESSAGES */
#messages{
  flex:1;
  overflow-y:auto;
  padding:24px;
  display:flex;
  flex-direction:column;
  gap:12px;
}
.bubble{
  max-width:78%;
  padding:12px 16px;
  border-radius:18px;
  font-size:16px;
}
.bubble.me{
  background:var(--signal-blue);
  color:white;
  align-self:flex-end;
  border-bottom-right-radius:6px;
}
.bubble.other{
  background:#f3f4f6;
  color:#111;
  align-self:flex-start;
  border-bottom-left-radius:6px;
}
.meta{
  font-size:12px;
  color:#6b7280;
  margin-bottom:4px;
}

/* INPUT */
footer{
  padding:14px;
  border-top:1px solid #eee;
  display:flex;
  gap:12px;
}
textarea{
  flex:1;
  resize:none;
  border:none;
  outline:none;
  background:#f7fafc;
  border-radius:24px;
  padding:12px 16px;
  font-size:16px;
}
.send-btn{
  width:48px;height:48px;
  border-radius:999px;
  background:var(--signal-blue);
  color:white;
  display:flex;
  align-items:center;
  justify-content:center;
}

/* TYPING INDICATOR */
#typing-indicator{
  padding:0 24px 8px;
  display:none;
}
.typing-bubble{
  background:#f3f4f6;
  border-radius:18px;
  padding:8px 12px;
  display:inline-flex;
}
.dots{display:flex;gap:6px}
.dot{
  width:8px;height:8px;
  background:#9ca3af;
  border-radius:50%;
  animation:bounce 1s infinite;
}
.dot:nth-child(2){animation-delay:.12s}
.dot:nth-child(3){animation-delay:.24s}
@keyframes bounce{
  0%,100%{transform:translateY(0)}
  50%{transform:translateY(-6px)}
}

/* ONBOARDING */
#onboarding{
  position:fixed;
  inset:0;
  background:#fff;
  z-index:999;
  display:flex;
  align-items:center;
  justify-content:center;
}
.form{
  background:#fff;
  padding:24px;
  border-radius:20px;
  width:100%;
  max-width:360px;
}
</style>
</head>

<body class="view-list">

<!-- ONBOARDING -->
<div id="onboarding">
  <form class="form" id="profileForm">
    <h2 class="text-xl font-bold mb-3">Your name</h2>
    <input id="nameInput" required class="w-full border px-3 py-2 rounded mb-4">
    <button class="w-full bg-indigo-600 text-white py-2 rounded">Continue</button>
  </form>
</div>

<div id="main-app">

<!-- SIDEBAR -->
<aside id="sidebar">
  <div class="p-6 text-2xl font-bold">Chats</div>
  <div class="px-3">
    <div onclick="switchChat()" class="p-4 rounded-xl bg-blue-50 flex gap-4 items-center cursor-pointer">
      <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=General"
           class="w-12 h-12 rounded-full bg-blue-100">
      <div>
        <div class="font-bold">General</div>
        <div class="text-sm text-gray-500">Public chat</div>
      </div>
    </div>
  </div>
</aside>

<!-- CHAT -->
<main id="main-chat" class="flex flex-col flex-1">
<header class="h-20 flex items-center px-6 border-b">
  <button onclick="goBack()" class="md:hidden mr-3 text-2xl">‚Üê</button>
  <h2 class="font-bold text-lg">General</h2>
</header>

<div id="messages"></div>

<div id="typing-indicator">
  <div class="text-xs text-gray-500 mb-1" id="typing-name"></div>
  <div class="typing-bubble">
    <div class="dots">
      <div class="dot"></div><div class="dot"></div><div class="dot"></div>
    </div>
  </div>
</div>

<footer>
  <textarea id="input" rows="1" placeholder="Signal Message"></textarea>
  <button id="send" class="send-btn">‚û§</button>
</footer>
</main>

</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyCY2qB4sbPs_7BIz355cQiQkDDqK-S_z4I",
  projectId:"flux-chat-b9cb2"
});
const db=firebase.firestore();
const CHAT="general";

const uid=localStorage.uid||(()=>{const x="u_"+Math.random().toString(36).slice(2,9);localStorage.uid=x;return x})();
const myName=()=>localStorage.name;

const messages=document.getElementById("messages");
const input=document.getElementById("input");
const send=document.getElementById("send");
const typingRef=db.collection("public").doc(CHAT).collection("typing");

/* onboarding */
if(localStorage.name) document.getElementById("onboarding").remove();
profileForm.onsubmit=e=>{
  e.preventDefault();
  localStorage.name=nameInput.value.trim();
  document.getElementById("onboarding").remove();
};

/* typing */
let t;
input.oninput=()=>{
  typingRef.doc(uid).set({name:myName(),typing:true},{merge:true});
  clearTimeout(t);
  t=setTimeout(()=>typingRef.doc(uid).set({typing:false},{merge:true}),1000);
};

typingRef.onSnapshot(s=>{
  let show=false,n="";
  s.forEach(d=>{
    if(d.id!==uid && d.data().typing){
      show=true;n=d.data().name;
    }
  });
  typingName.textContent=n;
  typingIndicator.style.display=show?"block":"none";
});

/* send ‚Äì INSTANT CLEAR */
send.onclick=async()=>{
  const text=input.value.trim();
  if(!text)return;
  input.value="";
  await db.collection("public").doc(CHAT).collection("messages").add({
    text,
    senderId:uid,
    name:myName(),
    time:Date.now()
  });
  typingRef.doc(uid).set({typing:false},{merge:true});
};

/* messages */
db.collection("public").doc(CHAT).collection("messages")
.orderBy("time")
.onSnapshot(s=>{
  messages.innerHTML="";
  s.forEach(d=>{
    const m=d.data();
    if(m.senderId!==uid){
      const meta=document.createElement("div");
      meta.className="meta";
      meta.textContent=m.name;
      messages.appendChild(meta);
    }
    const b=document.createElement("div");
    b.className="bubble "+(m.senderId===uid?"me":"other");
    b.textContent=m.text;
    messages.appendChild(b);
  });
  messages.scrollTop=messages.scrollHeight;
});

/* navigation */
function switchChat(){document.body.className="view-chat"}
function goBack(){document.body.className="view-list"}
</script>
</body>
</html>
