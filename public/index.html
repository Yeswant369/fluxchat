<!DOCTYPE html>
<html lang="en">
<head>
<link rel="manifest" href="/manifest.json">
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>Signal Chat UI</title>
<meta name="theme-color" content="#2C6BED">

<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">

<style>
:root{
  --signal-blue:#2C6BED;
  --ios-curve:cubic-bezier(0.4,0,0.2,1);
}
body{
  font-family:'Inter',sans-serif;
  background:#000;height:100dvh;margin:0;overflow:hidden;
  display:flex;align-items:center;justify-content:center;
}
.bg-signal-blue{background-color:var(--signal-blue);}
.scrollbar-hide::-webkit-scrollbar{display:none;}
#main-app{display:flex;width:100%;height:100%;background:#fff;overflow:hidden;}
#sidebar,#main-chat{height:100%;transition:transform .5s var(--ios-curve),opacity .4s ease;}
@media(max-width:767px){
  #sidebar{width:100%;position:absolute;z-index:10}
  #main-chat{width:100%;position:absolute;transform:translateX(100%);z-index:20}
  .view-list #sidebar{transform:translateX(0)}
  .view-chat #sidebar{transform:translateX(-25%);opacity:.9}
  .view-chat #main-chat{transform:translateX(0)}
}
@media(min-width:768px){
  #main-app{height:95dvh;max-width:1280px;border-radius:1.25rem;border:1px solid #e5e7eb}
  #sidebar{width:360px;border-right:1px solid #f3f4f6}
  #main-chat{flex:1;transform:none!important}
}
.btn-touch:active{transform:scale(.92);opacity:.7}
.message-appear{animation:popIn .3s cubic-bezier(.175,.885,.32,1.2)}
@keyframes popIn{
  from{opacity:0;transform:scale(.9) translateY(10px)}
  to{opacity:1;transform:scale(1) translateY(0)}
}

/* iOS typing dots */
.typing-dots span{
  width:8px;height:8px;background:#bbb;border-radius:50%;
  display:inline-block;
  animation:typing 1.4s infinite both;
}
.typing-dots span:nth-child(1){animation-delay:0s}
.typing-dots span:nth-child(2){animation-delay:.2s}
.typing-dots span:nth-child(3){animation-delay:.4s}
@keyframes typing{
  0%{opacity:.2;transform:translateY(0)}
  20%{opacity:1;transform:translateY(-4px)}
  40%{opacity:.2;transform:translateY(0)}
}
</style>
</head>

<body class="view-list">

<!-- ================= ONBOARDING ================= -->
<div id="onboarding-overlay" class="fixed inset-0 z-50 flex items-center justify-center bg-gradient-to-br from-blue-50 to-indigo-100">
  <div class="bg-white p-10 rounded-[2.5rem] shadow-xl max-w-md w-full">
    <h1 class="text-3xl font-extrabold text-center mb-2">Welcome</h1>
    <p class="text-gray-500 text-center mb-6">Let's get to know you better</p>
    <form id="profileForm" class="space-y-6">
      <input id="name" required class="w-full px-5 py-4 rounded-2xl bg-gray-100 outline-none" placeholder="Type your name…" />
      <button class="w-full bg-indigo-600 text-white py-4 rounded-2xl font-black">Continue</button>
    </form>
  </div>
</div>

<!-- ================= APP ================= -->
<div id="main-app">

<!-- SIDEBAR -->
<aside id="sidebar" class="flex flex-col">
  <div class="p-6"><h1 class="font-bold text-2xl">Chats</h1></div>
  <div class="px-3">
    <div onclick="switchChat()" class="p-4 rounded-2xl flex gap-4 cursor-pointer bg-blue-50">
      <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=General" class="w-14 h-14 rounded-full bg-blue-100">
      <div>
        <div class="font-bold">General</div>
        <div class="text-sm text-gray-500">Public chat</div>
      </div>
    </div>
  </div>
</aside>

<!-- CHAT -->
<main id="main-chat" class="flex flex-col">
<header class="h-20 flex items-center px-6 border-b">
<button onclick="goBack()" class="md:hidden mr-3 text-3xl font-bold">&larr;</button>
<h2 class="font-bold">General</h2>
</header>

<div id="messages-container" class="flex-1 overflow-y-auto px-6 py-6 space-y-4 scrollbar-hide">

  <!-- typing indicator (INSIDE FLOW) -->
  <div id="typing-indicator" class="hidden">
    <div class="flex items-center gap-2 bg-gray-100 px-4 py-3 rounded-2xl w-fit">
      <div class="typing-dots flex gap-1">
        <span></span><span></span><span></span>
      </div>
    </div>
  </div>

</div>

<footer class="p-4 border-t flex gap-3">
<textarea id="message-input" rows="1"
 class="flex-1 bg-gray-50 rounded-2xl px-4 py-2 resize-none"
 placeholder="Signal Message"></textarea>
<button id="send-btn"
 class="btn-touch w-12 h-12 bg-signal-blue text-white rounded-full flex items-center justify-center">➤</button>
</footer>
</main>
</div>

<!-- ================= FIREBASE ================= -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyCY2qB4sbPs_7BIz355cQiQkDDqK-S_z4I",
  projectId:"flux-chat-b9cb2"
});
const db=firebase.firestore();

const MY_ID=localStorage.signal_id||(()=>{
  const id="user_"+Math.random().toString(36).slice(2,9);
  localStorage.signal_id=id;return id;
})();

const messagesContainer=document.getElementById("messages-container");
const messageInput=document.getElementById("message-input");
const typingIndicator=document.getElementById("typing-indicator");

function switchChat(){document.body.className="view-chat";}
function goBack(){document.body.className="view-list";}

/* MESSAGE LISTENER */
db.collection("public").doc("general").collection("messages")
.orderBy("createdAt")
.onSnapshot(snap=>{
  messagesContainer.innerHTML="";
  snap.forEach(doc=>{
    const m=doc.data();
    const wrap=document.createElement("div");
    wrap.className=`flex flex-col ${m.senderId===MY_ID?"items-end":"items-start"} message-appear`;

    if(m.senderId!==MY_ID){
      const n=document.createElement("div");
      n.className="text-xs text-gray-500 mb-1";
      n.textContent=m.name;
      wrap.appendChild(n);
    }

    const b=document.createElement("div");
    b.className=m.senderId===MY_ID
      ?"bg-signal-blue text-white px-4 py-3 rounded-2xl rounded-br-none"
      :"bg-gray-100 px-4 py-3 rounded-2xl rounded-bl-none";
    b.textContent=m.text;
    wrap.appendChild(b);
    messagesContainer.appendChild(wrap);
  });
  messagesContainer.appendChild(typingIndicator);
  messagesContainer.scrollTop=messagesContainer.scrollHeight;
});

/* TYPING INDICATOR */
const typingRef=db.collection("public").doc("general").collection("typing").doc(MY_ID);
let typingTimeout;

messageInput.addEventListener("input",()=>{
  typingRef.set({typing:true,name:localStorage.chat_name});
  clearTimeout(typingTimeout);
  typingTimeout=setTimeout(()=>{
    typingRef.set({typing:false},{merge:true});
  },800);
});

db.collection("public").doc("general").collection("typing")
.onSnapshot(snap=>{
  let show=false;
  snap.forEach(doc=>{
    if(doc.id!==MY_ID && doc.data().typing) show=true;
  });
  typingIndicator.classList.toggle("hidden",!show);
});

/* SEND MESSAGE */
document.getElementById("send-btn").onclick=async()=>{
  if(!messageInput.value.trim())return;
  await db.collection("public").doc("general").collection("messages").add({
    text:messageInput.value,
    senderId:MY_ID,
    name:localStorage.chat_name,
    createdAt:firebase.firestore.FieldValue.serverTimestamp()
  });
  typingRef.set({typing:false},{merge:true});
  messageInput.value="";
};

/* ONBOARDING */
const overlay=document.getElementById("onboarding-overlay");
if(localStorage.chat_name) overlay.remove();
document.getElementById("profileForm").onsubmit=e=>{
  e.preventDefault();
  localStorage.chat_name=document.getElementById("name").value;
  overlay.remove();
};
</script>

</body>
</html>
