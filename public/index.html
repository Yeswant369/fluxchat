<!DOCTYPE html>
<html lang="en">
<head>
<link rel="manifest" href="/manifest.json">
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>Signal Chat UI</title>
<meta name="theme-color" content="#2C6BED">

<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">

<style>
/* ================= SIGNAL UI ================= */
:root{
  --signal-blue:#2C6BED;
  --ios-curve:cubic-bezier(0.4,0,0.2,1);
}
body{
  font-family:'Inter',sans-serif;
  background:#000;height:100dvh;margin:0;overflow:hidden;
  display:flex;align-items:center;justify-content:center;
}
.bg-signal-blue{background-color:var(--signal-blue);}
.scrollbar-hide::-webkit-scrollbar{display:none;}

#main-app{display:flex;width:100%;height:100%;background:#fff;overflow:hidden;}
#sidebar,#main-chat{height:100%;transition:transform .5s var(--ios-curve),opacity .4s ease;}

@media(max-width:767px){
  #sidebar{width:100%;position:absolute;z-index:10}
  #main-chat{width:100%;position:absolute;transform:translateX(100%);z-index:20}
  .view-list #sidebar{transform:translateX(0)}
  .view-chat #sidebar{transform:translateX(-25%);opacity:.9}
  .view-chat #main-chat{transform:translateX(0)}
}
@media(min-width:768px){
  #main-app{height:95dvh;max-width:1280px;border-radius:1.25rem;border:1px solid #e5e7eb}
  #sidebar{width:360px;border-right:1px solid #f3f4f6}
  #main-chat{flex:1;transform:none!important}
}

.message-appear{animation:popIn .25s cubic-bezier(.175,.885,.32,1.2)}
@keyframes popIn{
  from{opacity:0;transform:translateY(6px) scale(.96)}
  to{opacity:1;transform:none}
}

/* ================= TYPING DOTS ================= */
.dot{
  width:6px;height:6px;margin:0 2px;
  background:#9ca3af;border-radius:50%;
  animation:bounce 1.4s infinite ease-in-out both;
}
.dot:nth-child(1){animation-delay:-.32s}
.dot:nth-child(2){animation-delay:-.16s}
@keyframes bounce{
  0%,80%,100%{transform:scale(0)}
  40%{transform:scale(1)}
}

/* ================= ONBOARDING ================= */
#onboarding{
  position:fixed;inset:0;z-index:9999;
  font-family:'Plus Jakarta Sans',sans-serif;
  background:linear-gradient(135deg,#f0f4ff,#e0eaff);
  display:flex;align-items:center;justify-content:center;
}
.form-card{
  background:rgba(255,255,255,.85);
  backdrop-filter:blur(20px);
  border-radius:2.5rem;
  padding:2.5rem;
}
</style>
</head>

<body class="view-list">

<!-- ================= ONBOARDING ================= -->
<div id="onboarding">
  <div class="form-card w-full max-w-md text-center">
    <h1 class="text-3xl font-extrabold mb-2">Welcome</h1>
    <p class="text-gray-500 mb-6">Enter your name</p>
    <form id="profileForm">
      <input id="nameInput" required
        class="w-full px-5 py-4 rounded-2xl border mb-6"
        placeholder="Your name" />
      <button class="w-full bg-indigo-600 text-white py-4 rounded-2xl font-black">
        Continue
      </button>
    </form>
  </div>
</div>

<!-- ================= APP ================= -->
<div id="main-app">

<!-- SIDEBAR -->
<aside id="sidebar" class="flex flex-col">
  <div class="p-6 font-bold text-2xl">Chats</div>
  <div class="px-3">
    <div class="p-4 rounded-2xl flex gap-4 bg-blue-50 cursor-pointer"
      onclick="switchChat()">
      <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=General"
        class="w-14 h-14 rounded-full bg-blue-100">
      <div>
        <div class="font-bold">General</div>
        <div class="text-sm text-gray-500">Public chat</div>
      </div>
    </div>
  </div>
</aside>

<!-- CHAT -->
<main id="main-chat" class="flex flex-col">
<header class="h-20 flex items-center px-6 border-b">
  <button onclick="goBack()" class="md:hidden mr-3 text-3xl">&larr;</button>
  <h2 class="font-bold text-lg">General</h2>
</header>

<div id="messages"
  class="flex-1 overflow-y-auto px-6 py-6 space-y-4 scrollbar-hide bg-white"></div>

<!-- Typing indicator -->
<div id="typing" class="hidden px-6 pb-2">
  <div id="typingName" class="text-xs text-gray-500 mb-1"></div>
  <div class="bg-gray-100 inline-flex px-4 py-3 rounded-2xl">
    <div class="dot"></div><div class="dot"></div><div class="dot"></div>
  </div>
</div>

<footer class="p-4 border-t flex gap-3">
  <textarea id="input"
    class="flex-1 bg-gray-50 rounded-2xl px-4 py-2 resize-none"
    placeholder="Signal Message"></textarea>
  <button id="send"
    class="w-12 h-12 bg-signal-blue text-white rounded-full">âž¤</button>
</footer>
</main>
</div>

<!-- ================= FIREBASE ================= -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyCY2qB4sbPs_7BIz355cQiQkDDqK-S_z4I",
  projectId:"flux-chat-b9cb2"
});
const db=firebase.firestore();

const MY_ID=localStorage.uid||(()=>{
  const id="u_"+Math.random().toString(36).slice(2,9);
  localStorage.uid=id;return id;
})();

const msgs=document.getElementById("messages");
const input=document.getElementById("input");
const send=document.getElementById("send");
const typingBox=document.getElementById("typing");
const typingName=document.getElementById("typingName");

function switchChat(){document.body.className="view-chat";}
function goBack(){document.body.className="view-list";}

/* ONBOARDING */
const overlay=document.getElementById("onboarding");
if(localStorage.name) overlay.remove();
document.getElementById("profileForm").onsubmit=e=>{
  e.preventDefault();
  localStorage.name=document.getElementById("nameInput").value;
  overlay.remove();
};

/* MESSAGES */
db.collection("public").doc("general").collection("messages")
.orderBy("createdAt")
.onSnapshot(s=>{
  msgs.innerHTML="";
  s.forEach(d=>{
    const m=d.data();
    const wrap=document.createElement("div");
    wrap.className=`flex flex-col ${m.sender===MY_ID?"items-end":"items-start"} message-appear`;

    if(m.sender!==MY_ID){
      const n=document.createElement("div");
      n.className="text-xs text-gray-500 mb-1";
      n.textContent=m.name;
      wrap.appendChild(n);
    }

    const b=document.createElement("div");
    b.className=m.sender===MY_ID
      ?"bg-signal-blue text-white px-4 py-3 rounded-2xl rounded-br-none"
      :"bg-gray-100 px-4 py-3 rounded-2xl rounded-bl-none";
    b.textContent=m.text;
    wrap.appendChild(b);

    msgs.appendChild(wrap);
  });
  msgs.scrollTop=msgs.scrollHeight;
});

/* TYPING */
const typingRef=db.collection("public").doc("general").collection("typing");
let tTimeout;

input.addEventListener("input",()=>{
  typingRef.doc(MY_ID).set({name:localStorage.name});
  clearTimeout(tTimeout);
  tTimeout=setTimeout(()=>typingRef.doc(MY_ID).delete(),1200);
});

typingRef.onSnapshot(s=>{
  let show=false;
  s.forEach(d=>{
    if(d.id!==MY_ID){
      typingName.textContent=d.data().name+" is typing";
      show=true;
    }
  });
  typingBox.classList.toggle("hidden",!show);
});

/* SEND */
send.onclick=async()=>{
  if(!input.value.trim())return;
  await db.collection("public").doc("general").collection("messages").add({
    text:input.value,
    sender:MY_ID,
    name:localStorage.name,
    createdAt:firebase.firestore.FieldValue.serverTimestamp()
  });
  await typingRef.doc(MY_ID).delete();
  input.value="";
};
</script>

</body>
</html>
