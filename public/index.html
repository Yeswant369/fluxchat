<!DOCTYPE html>
<html lang="en">
<head>
<link rel="manifest" href="/manifest.json">
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>Signal Chat UI</title>
<meta name="theme-color" content="#2C6BED">

<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
:root {
  --signal-blue:#2C6BED;
  --ios-curve:cubic-bezier(0.4,0,0.2,1);
}
body{
  font-family:'Inter',sans-serif;
  background:#000;height:100dvh;margin:0;overflow:hidden;
  display:flex;align-items:center;justify-content:center;
}
#main-app{display:flex;width:100%;height:100%;background:#fff;overflow:hidden;}
#sidebar,#main-chat{height:100%;transition:transform .45s var(--ios-curve),opacity .35s ease;}
@media(max-width:767px){
  #sidebar{width:100%;position:absolute;z-index:10}
  #main-chat{width:100%;position:absolute;transform:translateX(100%);z-index:20}
  .view-list #sidebar{transform:translateX(0)}
  .view-chat #sidebar{transform:translateX(-25%);opacity:.9}
  .view-chat #main-chat{transform:translateX(0)}
}
@media(min-width:768px){
  #main-app{height:95dvh;max-width:1280px;border-radius:1.25rem;border:1px solid #e5e7eb}
  #sidebar{width:360px;border-right:1px solid #f3f4f6}
  #main-chat{flex:1}
}
.message-appear{animation:pop .25s ease}
@keyframes pop{
  from{opacity:0;transform:translateY(8px) scale(.96)}
  to{opacity:1;transform:none}
}
.bubble{
  max-width:78%;
  padding:.75rem 1rem;
  border-radius:1.25rem;
  font-size:.95rem;
}
.me{background:var(--signal-blue);color:#fff;border-bottom-right-radius:.25rem}
.other{background:#f1f3f5;color:#111;border-bottom-left-radius:.25rem}
.typing{
  background:#f1f3f5;
  border-radius:1.25rem;
  padding:.7rem 1rem;
  display:flex;
  gap:6px;
  width:54px;
}
.dot{
  width:6px;height:6px;border-radius:50%;
  background:#9ca3af;
  animation:bounce 1.4s infinite;
}
.dot:nth-child(2){animation-delay:.15s}
.dot:nth-child(3){animation-delay:.3s}
@keyframes bounce{
  0%,80%,100%{transform:translateY(0)}
  40%{transform:translateY(-6px)}
}
</style>
</head>

<body class="view-list">

<div id="main-app">

<!-- SIDEBAR -->
<aside id="sidebar" class="flex flex-col">
  <div class="p-6 text-2xl font-bold">Chats</div>
  <div class="px-4">
    <div onclick="switchChat()"
      class="p-4 rounded-2xl bg-blue-50 font-semibold cursor-pointer">
      General
    </div>
  </div>
</aside>

<!-- CHAT -->
<main id="main-chat" class="flex flex-col">
<header class="h-16 flex items-center px-5 border-b">
  <button onclick="goBack()" class="md:hidden mr-3 text-xl">‚Üê</button>
  <h2 class="font-bold">General</h2>
</header>

<div id="messages" class="flex-1 overflow-y-auto px-5 py-4 space-y-4"></div>

<div id="typing-indicator" class="px-5 mb-2 hidden">
  <div class="typing">
    <div class="dot"></div><div class="dot"></div><div class="dot"></div>
  </div>
</div>

<footer class="p-4 border-t flex gap-3">
<textarea id="input"
  rows="1"
  placeholder="Signal Message"
  class="flex-1 bg-gray-100 rounded-2xl px-4 py-2 resize-none"></textarea>
<button onclick="sendMessage()"
  class="w-12 h-12 bg-blue-600 text-white rounded-full flex items-center justify-center">
‚û§
</button>
</footer>
</main>

</div>

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
firebase.initializeApp({
  apiKey: "AIzaSyCY2qB4sbPs_7BIz355cQiQkDDqK-S_z4I",
  projectId: "flux-chat-b9cb2"
});
const db = firebase.firestore();

const CHAT_ID = "general";
const MY_ID = localStorage.uid || (localStorage.uid="u_"+Math.random().toString(36).slice(2));
const MY_NAME = localStorage.name || prompt("Enter your name");

localStorage.name = MY_NAME;

const messages = document.getElementById("messages");
const input = document.getElementById("input");
const typingBox = document.getElementById("typing-indicator");

function switchChat(){document.body.className="view-chat";}
function goBack(){document.body.className="view-list";}

/* üî• REALTIME MESSAGES */
db.collection("public").doc(CHAT_ID)
.collection("messages").orderBy("createdAt")
.onSnapshot(snap=>{
  messages.innerHTML="";
  snap.forEach(doc=>{
    const m = doc.data();
    const wrap = document.createElement("div");
    wrap.className = "flex flex-col " + (m.senderId===MY_ID?"items-end":"items-start")+" message-appear";

    if(m.senderId!==MY_ID){
      const n=document.createElement("div");
      n.className="text-xs text-gray-500 mb-1";
      n.textContent=m.name;
      wrap.appendChild(n);
    }

    const b=document.createElement("div");
    b.className="bubble "+(m.senderId===MY_ID?"me":"other");
    b.textContent=m.text;
    wrap.appendChild(b);
    messages.appendChild(wrap);
  });
  messages.scrollTop=messages.scrollHeight;
});

/* ‚ö° OPTIMISTIC SEND */
function sendMessage(){
  const text=input.value.trim();
  if(!text) return;

  input.value="";
  input.style.height="auto";

  const wrap=document.createElement("div");
  wrap.className="flex flex-col items-end message-appear";
  const b=document.createElement("div");
  b.className="bubble me";
  b.textContent=text;
  wrap.appendChild(b);
  messages.appendChild(wrap);
  messages.scrollTop=messages.scrollHeight;

  db.collection("public").doc(CHAT_ID).collection("messages").add({
    text,
    senderId:MY_ID,
    name:MY_NAME,
    createdAt:firebase.firestore.FieldValue.serverTimestamp()
  });

  db.collection("typing").doc(CHAT_ID).collection("users").doc(MY_ID)
    .set({typing:false});
}

/* ‚úçÔ∏è TYPING INDICATOR */
input.addEventListener("input",()=>{
  input.style.height="auto";
  input.style.height=input.scrollHeight+"px";
  db.collection("typing").doc(CHAT_ID).collection("users").doc(MY_ID)
    .set({typing:true,name:MY_NAME});
  clearTimeout(window._typingTimeout);
  window._typingTimeout=setTimeout(()=>{
    db.collection("typing").doc(CHAT_ID).collection("users").doc(MY_ID)
      .set({typing:false});
  },1200);
});

db.collection("typing").doc(CHAT_ID).collection("users")
.onSnapshot(snap=>{
  let show=false;
  snap.forEach(d=>{
    const t=d.data();
    if(d.id!==MY_ID && t.typing) show=true;
  });
  typingBox.classList.toggle("hidden",!show);
});
</script>
</body>
</html>
